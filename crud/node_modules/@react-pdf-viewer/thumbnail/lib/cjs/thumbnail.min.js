"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core");function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r=n(e),a=function(){return a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},a.apply(this,arguments)},i=function(e){var n=e.getPageIndex,a=e.renderSpinner,i=e.doc,u=r.useState(""),o=u[0],c=u[1],l=t.useIsMounted(),s=r.useRef(),d=t.useIntersectionObserver({onVisibilityChanged:function(e){if(!o&&e.isVisible){var r=d.current;if(r){var a=i.numPages,u=n?n({numPages:a}):0,g=Math.max(0,Math.min(u,a-1));t.getPage(i,g).then((function(e){var t=e.getViewport({scale:1}),n=t.width,a=t.height,i=document.createElement("canvas"),u=i.getContext("2d",{alpha:!1}),o=r.clientWidth,d=r.clientHeight,g=Math.min(o/n,d/a),h=g*n,p=g*a;i.height=p,i.width=h,i.style.opacity="0";var m=e.getViewport({rotation:0,scale:g});s.current=e.render({canvasContext:u,viewport:m}),s.current.promise.then((function(){l.current&&c(i.toDataURL()),i.width=0,i.height=0}),(function(){}))}))}}}});return r.useEffect((function(){return function(){var e;null===(e=s.current)||void 0===e||e.cancel()}}),[]),o?r.createElement("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:o}):r.createElement("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader",ref:d},a?a():r.createElement(t.Spinner,null))},u=function(e){var n=e.getPageIndex,a=e.renderSpinner,u=e.store,o=r.useState(u.get("doc")),c=o[0],l=o[1],s=function(e){l(e)};return r.useEffect((function(){return u.subscribe("doc",s),function(){u.unsubscribe("doc",s)}}),[]),r.createElement("div",{className:"rpv-thumbnail__cover"},c?r.createElement(i,{doc:c,getPageIndex:n,renderSpinner:a}):r.createElement("div",{className:"rpv-thumbnail__cover-loader"},a?a():r.createElement(t.Spinner,null)))},o=function(){return r.createElement(t.Spinner,null)},c=r.createContext({renderSpinner:o}),l=function(e){var n=e.children,a=e.doc,i=t.useIsMounted(),u=r.useState({loading:!0,labels:[]}),o=u[0],c=u[1];return r.useEffect((function(){a.getPageLabels().then((function(e){i.current&&c({loading:!1,labels:e||[]})}))}),[a.loadingTask.docId]),o.loading?r.createElement(r.Fragment,null):n(o.labels)},s=function(e){var n=e.page,a=e.pageHeight,i=e.pageIndex,u=e.pageWidth,o=e.rotation,l=e.thumbnailHeight,s=e.thumbnailWidth,d=e.onRenderCompleted,g=r.useContext(t.LocalizationContext).l10n,h=r.useRef(),p=r.useState(""),m=p[0],f=p[1],b=g&&g.thumbnail?g.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return r.useEffect((function(){var e=h.current;e&&e.cancel();var t=document.createElement("canvas"),r=t.getContext("2d",{alpha:!1}),c=s,l=c/(u/a),g=c/u;t.height=l,t.width=c,t.style.height="".concat(l,"px"),t.style.width="".concat(c,"px");var p=n.getViewport({rotation:o,scale:g});return h.current=n.render({canvasContext:r,viewport:p}),h.current.promise.then((function(){f(t.toDataURL()),d(i)}),(function(){d(i)})),function(){var e;null===(e=h.current)||void 0===e||e.cancel()}}),[o]),m?r.createElement("img",{"aria-label":b.replace("{{pageIndex}}","".concat(i+1)),src:m,height:"".concat(l,"px"),width:"".concat(s,"px")}):r.useContext(c).renderSpinner()},d=function(e){var n=e.doc,a=e.pageHeight,i=e.pageIndex,u=e.pageRotation,o=e.pageWidth,l=e.rotation,d=e.shouldRender,g=e.thumbnailWidth,h=e.onRenderCompleted,p=e.onVisibilityChanged,m=r.useState({height:a,page:null,viewportRotation:0,width:o}),f=m[0],b=m[1],v=f.page,P=f.height,_=f.width,E=_/P,x=Math.abs(l+u)%180==0,R=x?g:g/E,I=x?g/E:g;r.useEffect((function(){d&&t.getPage(n,i).then((function(e){var t=e.getViewport({scale:1});b({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[d]);var C=(f.viewportRotation+l+u)%360,S=t.useIntersectionObserver({onVisibilityChanged:function(e){p(i,e)}});return r.createElement("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(i),ref:S,style:{height:"".concat(I,"px"),width:"".concat(R,"px")}},v?r.createElement(s,{page:v,pageHeight:x?P:_,pageIndex:i,pageWidth:x?_:P,rotation:C,thumbnailHeight:I,thumbnailWidth:R,onRenderCompleted:h}):r.useContext(c).renderSpinner())},g=function(e){var n=e.currentPage,a=e.doc,i=e.pagesRotation,u=e.pageHeight,o=e.pageWidth,c=e.renderCurrentPageLabel,s=e.renderThumbnailItem,g=e.rotatedPage,h=e.rotation,p=e.thumbnailWidth,m=e.onJumpToPage,f=e.onRotatePage,b=a.numPages,v=a.loadingTask.docId,P=r.useRef(null),_=r.useRef([]),E=r.useState(n),x=E[0],R=E[1],I=r.useContext(t.ThemeContext).direction===t.TextDirection.RightToLeft,C=r.useState(-1),S=C[0],w=C[1],y=t.useIsMounted(),T=r.useRef(!1),W=r.useMemo((function(){return Array(b).fill(0).map((function(e,t){return t}))}),[v]),L=r.useRef();r.useEffect((function(){var e=L.current=t.renderQueueService({doc:a,queueName:"thumbnail-list",priority:999});return function(){e.cleanup()}}),[v]);var k=function(e){switch(e.key){case"ArrowDown":H();break;case"ArrowUp":N();break;case"Enter":O()}},H=function(){if(P.current){var e=_.current,t=x+1;t<e.length&&(x>=0&&e[x].setAttribute("tabindex","-1"),R(t))}},N=function(){if(P.current){var e=_.current,t=x-1;t>=0&&(x>=0&&e[x].setAttribute("tabindex","-1"),R(t))}},O=function(){x>=0&&x<b&&m(x)};t.useIsomorphicLayoutEffect((function(){var e=P.current;e&&(_.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[]),r.useEffect((function(){var e=_.current;if(!(0===e.length||x<0||x>e.length)){var t=e[x];t.setAttribute("tabindex","0"),t.focus()}}),[x]),t.useIsomorphicLayoutEffect((function(){var e=P.current;if(e){var t=e.children;n<t.length&&function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,r=e.clientHeight,a=t.clientHeight;n<0?t.scrollTop+=n:n+r<=a||(t.scrollTop+=n+r-a)}(t.item(n),e)}}),[n]);var V=r.useCallback((function(e){y.current&&(L.current.markRendered(e),T.current=!1,j())}),[v]),M=r.useCallback((function(e,t){L.current.setVisibility(e,t.isVisible?t.ratio:L.current.OUT_OF_RANGE_VISIBILITY),j()}),[v]),j=r.useCallback((function(){if(!T.current){var e=L.current.getHighestPriorityPage();e>-1&&(L.current.markRendering(e),T.current=!0,w(e))}}),[v]);return r.useEffect((function(){g>=0&&(L.current.markRendering(g),T.current=!0,w(g))}),[v,g]),r.createElement(l,{doc:a},(function(e){return r.createElement("div",{ref:P,"data-testid":"thumbnail__list",className:t.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--rtl":I}),onKeyDown:k},W.map((function(l){var g="".concat(a.loadingTask.docId,"___").concat(l),v=e.length===b?e[l]:"".concat(l+1),P=c?c({currentPage:n,pageIndex:l,numPages:b,pageLabel:v}):v,_=i.has(l)?i.get(l):0,E=r.createElement(d,{doc:a,pageHeight:u,pageIndex:l,pageRotation:_,pageWidth:o,rotation:h,shouldRender:S===l,thumbnailWidth:p,onRenderCompleted:V,onVisibilityChanged:M});return s?s({currentPage:n,key:g,numPages:b,pageIndex:l,renderPageLabel:r.createElement(r.Fragment,null,P),renderPageThumbnail:E,onJumpToPage:function(){return m(l)},onRotatePage:function(e){return f(l,e)}}):r.createElement("div",{key:g},r.createElement("div",{className:t.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--selected":n===l}),role:"button",tabIndex:n===l?0:-1,onClick:function(){return m(l)}},E),r.createElement("div",{"data-testid":"thumbnail__label-".concat(l),className:"rpv-thumbnail__label"},P))})))}))},h=function(e){var n=e.renderCurrentPageLabel,a=e.renderThumbnailItem,i=e.store,u=e.thumbnailWidth,o=r.useState(i.get("doc")),l=o[0],s=o[1],d=r.useState(i.get("currentPage")||0),h=d[0],p=d[1],m=r.useState(i.get("pageHeight")||0),f=m[0],b=m[1],v=r.useState(i.get("pageWidth")||0),P=v[0],_=v[1],E=r.useState(i.get("rotation")||0),x=E[0],R=E[1],I=r.useState(i.get("pagesRotation")||new Map),C=I[0],S=I[1],w=r.useState(i.get("rotatedPage")||-1),y=w[0],T=w[1],W=function(e){p(e)},L=function(e){s(e)},k=function(e){b(e)},H=function(e){_(e)},N=function(e){R(e)},O=function(e){S(e)},V=function(e){T(e)};return r.useEffect((function(){return i.subscribe("doc",L),i.subscribe("pageHeight",k),i.subscribe("pageWidth",H),i.subscribe("rotatedPage",V),i.subscribe("rotation",N),i.subscribe("pagesRotation",O),function(){i.unsubscribe("doc",L),i.unsubscribe("pageHeight",k),i.unsubscribe("pageWidth",H),i.unsubscribe("rotatedPage",V),i.unsubscribe("rotation",N),i.unsubscribe("pagesRotation",O)}}),[]),t.useIsomorphicLayoutEffect((function(){return i.subscribe("currentPage",W),function(){i.unsubscribe("currentPage",W)}}),[]),l?r.createElement(t.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"}},r.createElement(g,{currentPage:h,doc:l,pagesRotation:C,pageHeight:f,pageWidth:P,renderCurrentPageLabel:n,renderThumbnailItem:a,rotatedPage:y,rotation:x,thumbnailWidth:u,onJumpToPage:function(e){var t=i.get("jumpToPage");t&&t(e)},onRotatePage:function(e,t){i.get("rotatePage")(e,t)}})):r.createElement("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader"},r.useContext(c).renderSpinner())};exports.thumbnailPlugin=function(e){var n=r.useMemo((function(){return t.createStore({rotatePage:function(){}})}),[]),i=r.useState(""),l=i[0],s=i[1];return{install:function(e){n.update("jumpToPage",e.jumpToPage),n.update("rotatePage",e.rotatePage)},onDocumentLoad:function(e){s(e.doc.loadingTask.docId),n.update("doc",e.doc)},onViewerStateChange:function(e){return n.update("currentPage",e.pageIndex),n.update("pagesRotation",e.pagesRotation),n.update("pageHeight",e.pageHeight),n.update("pageWidth",e.pageWidth),n.update("rotation",e.rotation),n.update("rotatedPage",e.rotatedPage),e},Cover:function(t){return r.createElement(u,a({},t,{renderSpinner:null==e?void 0:e.renderSpinner,store:n}))},Thumbnails:r.useCallback((function(t){return r.createElement(c.Provider,{value:{renderSpinner:(null==e?void 0:e.renderSpinner)||o}},r.createElement(h,{renderCurrentPageLabel:null==e?void 0:e.renderCurrentPageLabel,renderThumbnailItem:null==t?void 0:t.renderThumbnailItem,store:n,thumbnailWidth:(null==e?void 0:e.thumbnailWidth)||100}))}),[l])}};
